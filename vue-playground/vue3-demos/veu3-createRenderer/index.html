<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="http://unpkg.com/vue@next"></script>-
</head>

<body>
    <script type="text/x-template" id="chart">
        <bar-chart :data="chartData"></bar-chart>
    </script>
    <div id="app"></div>
</body>




<script>
    const { createRenderer } = Vue
    const renderer = createRenderer({
        // 创建元素
        createElement(tag, isSVG, is) {
            return { tag }
        },
        // 插入元素
        insert(child, parent, anchor) {
            child.parent = parent
            if (!parent.childs) {
                parent.childs = []
            } else {
                parent.childs.push(child)
            }
            // 如果当前节点是画布，执行绘画逻辑
            if (parent.nodeType === 1) {
                draw(child)
            }
        },
        // 元素属性比较
        patchProp(el, key, prevValue, nextValue) {
            el[key] = nextValue
        }
        // 自己平台其它更多的操作方法
        // ...
    })

    const draw = (el, noClear) => {
        if (!noClear) {
            ctx.clearRect(0, 0, canvas.width, canvas.height)
        }
        if (el.tag === 'bar-chart') {
            const { data } = el
            console.log(111 ,el)
            const barWidth = canvas.width / 10,
                gap = 20,
                paddingLeft = (data.length * barWidth + (data.length - 1) * gap) / 3,
                paddingBootom = 10;

            data.forEach(({ title, count, color }, index) => {
                const x = paddingLeft + index * (barWidth + gap)
                const y = canvas.height - paddingBootom - count
                ctx.fillStyle = color
                ctx.fillRect(x, y, barWidth, count)
            })
        }

        // 递归
        el.childs && el.childs.forEach(child => draw(child, true))
    }

    let canvas, ctx;

    function createCanvasApp(App) {
        const app = renderer.createApp(App)
        app.config.isCustomElement = tag => tag === 'bar-chart'

        const mount = app.mount
        // 重写mount方法，执行初始操作
        app.mount = function (selector) {
            canvas = document.createElement('canvas')
            canvas.width = window.innerWidth
            canvas.height = window.innerHeight
            document.querySelector(selector).appendChild(canvas)

            ctx = canvas.getContext('2d')

            mount(canvas)
        }
        // 返回app，以供链式调用及摇数优化
        return app
    }
    var chartData =  [
                    { title: '青铜', count: 200, color: 'red' },
                    { title: '白银', count: 150, color: 'yellow' },
                    { title: '黄金', count: 100, color: 'gray' },
                    { title: '钻石', count: 80, color: 'green' },
                    { title: '王者', count: 50, color: 'gold' }
                ]
    var ins = createCanvasApp({
        template: '#chart',
        data() {
            return {
                chartData:chartData
            }
        },
        methods: {
            del () {
                this.chartData.pop()
            }
        }
    })
    ins.mount('#app')




</script>

</html>